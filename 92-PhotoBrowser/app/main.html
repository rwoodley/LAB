<!DOCTYPE html>
<!--
    todo:
    show/hide is still flakey
    put bash statements in a script.
    simplify css and divs.
    camera should always be at unit vector.
    modularize so you can reuse.
    load new stills and videos.
    -->
<html lang="en">
	<head>
        <style>
			body {
				font-family: Monospace;
				background-color: #000;
				margin: 0px;
				overflow: hidden;
			}
			.statusText {
				height:30px;
				width:300px;
				color: #00ff00;
				padding: 5px;
				background-color: black;
			}
            .controlPanel {
                position: fixed;
                top: 0;
                width: 95%;
            }
            .controlPanelInner {
                width: 90%;
                margin: 0 auto;             
            }
            .videoPanel {
                position: fixed;
                bottom: 0;
                width: 95%;
            }
            .videoPanelInner {
                width: 95%;
                margin: 0 auto;             
            }
            .cameraPanel {
                position: fixed;
                bottom: 10%;
                width: 95%;
            }
            .cameraPanelInner {
                width: 95%;
                margin: 0 auto;             
            }
            .cselector { 
                border: 2px solid; 
                border-color: #6495ED; margin: 5px; padding: 5px; color: #000000; 
                background-color: rgba(88,88,255,.5);
                width: 40px;
                height: 40px;
                display: inline-block;
                vertical-align: middle;
            }
            .videoControlIcon { 
                border: 2px solid; 
                border-color: #6495ED; margin: 5px; padding: 5px; color: #000000; 
                background-color: rgba(255,88,88,.5);
                width: 40px;
                height: 40px;
                display: inline-block;
                vertical-align: middle;
            }
            .tselector { 
                font-size: 8pt;
                border: 2px solid; 
                border-color: #6495ED; margin: 5px; padding: 5px; color: #000000; 
                background-color: rgba(88,255,88,.5);
                width: 60px;
                display: inline-block;
                vertical-align: middle;
                margin-left: 20px;
            }
            .vselector { 
                font-size: 8pt;
                border: 2px solid; 
                border-color: #6495ED; margin: 5px; padding: 5px; color: #000000; 
                background-color: rgba(88,88,255,.5);
                width: 60px;
                display: inline-block;
                vertical-align: middle;
                margin-left: 20px;
            }
		</style>
        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        
          ga('create', 'UA-41066114-1', 'rwoodley.org');
          ga('send', 'pageview');
        
        </script>
		<script src="r73/three.js"></script>
        <script src="r73/OrbitControls.js"></script>
		<script src="r73/Detector.js"></script>
 		<script src="r73/stats.min.js"></script>
		<script src="lib/jquery-3.1.0.min.js"></script>
        <script src="utils.js"></script>
        <!-- generate files.js with this bash:
        echo 'myTextures=["'`ls -1tr *.jpg *.JPG|tr '\n' ','|sed -e 's/,/","/g'|sed -e 's/.jpg//g'|sed -e 's/.JPG//g'|sed -e 's/,\"$//'  `']' > files.js
        echo 'myVideos=["'`ls -1tr *.mp4 |tr '\n' ','|sed -e 's/,/","/g'|sed -e 's/.mp4//g'|sed -e 's/.MP4//g'|sed -e 's/,\"$//'  `']' > videos.js
        -->
        <script src="textures/files.js"></script>
        <script src="textures/videos.js"></script>
		<script>
			var _container;
			var _camera, _controls, _scene, _renderer, _uniforms, _axes;
			var myMesh, _rotateSpeed = Math.PI/1024, _controlPanelVisible = true;

			if ( ! Detector.webgl ) {
				Detector.addGetWebGLMessage();
				document.getElementById( 'container' ).innerHTML = "";
			}

			var clock = new THREE.Clock();
			function toggleControlPanel() {
		    	_controlPanelVisible = !_controlPanelVisible;
		    	if (_controlPanelVisible) {
					$('.controlPanel').hide();
					$('.videoPanel').hide();
					_axes.visible = true;
				}
	    		else {
					$('.controlPanel').show();
					$('.videoPanel').show();
					_axes.visible = false;
				}
			}
            function setupMediaIcons() {
                var textureListHTML = '';
                for (var i = 0; i < myTextures.length; i++)
                    textureListHTML += "<span onclick='updateSkyDome(\"111\")' onmouseover='updateSkyDome(\"111\")' class='tselector'>111</span>"
                                    .replace(/111/g, myTextures[i]);
                // document.getElementById('textureList').innerHTML = textureListHTML;

                var videoListHTML = '';
                for (var i = 0; i < myVideos.length; i++)
                    videoListHTML += "<span onclick='updateVideo(\"111\")' onmouseover='updateVideo(\"111\")' class='vselector'>111</span>"
                                    .replace(/111/g, myVideos[i]);
                // document.getElementById('videoList').innerHTML = videoListHTML;
                document.getElementById('mediaList').innerHTML = textureListHTML + videoListHTML;

            }
			function init() {
                setupMediaIcons();
                initVideo();
				document.body.onkeyup = function(e){
				    if(e.keyCode == 32)
				    	toggleControlPanel();
				}
                _container = document.getElementById( 'container' );

                _camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 20000 );

                _scene = new THREE.Scene();
                _controls = new THREE.OrbitControls( _camera, _container.domElement );
                _renderer =  new THREE.WebGLRenderer({ antialias: true } );

                _camera.position.x = -1; _camera.position.y = 0.0; _camera.position.z = 0;
                _axes = new THREE.AxisHelper( 5000 );
                // _scene.add(_axes);
				toggleControlPanel();
                var segment = 256.;
                var sphereRadius = 10;

                var skyGeometry = new THREE.SphereGeometry(sphereRadius,segment,segment);
				var newMaterial = new THREE.MeshNormalMaterial();
                _skyBox = new THREE.Mesh( skyGeometry, newMaterial);
                _scene.add( _skyBox );
                _skyBox.position.set(0,0,0);
                _skyBox.scale.set(1,1,-1);

                _renderer.setSize( window.innerWidth, window.innerHeight );

                document.getElementById( 'container' ).innerHTML = "";
                _container.appendChild( _renderer.domElement );
                // playVideo();
                animate();
			}

			var _video, _videoTexture, _videoSource;
            var _videoDisplayed = false;
            var _rotateYAmount = 0;
			function animate() {
				requestAnimationFrame( animate );
				_controls.update( clock.getDelta() );
				_renderer.render( _scene, _camera );
                _unitVector = (new THREE.Vector3()).copy(_camera.position).normalize();
                _camera.position.set(_unitVector.x, _unitVector.y, _unitVector.z);
                console.log(_camera.position);
                _camera.lookAt(new THREE.Vector3(0,0,0));
                _skyBox.rotateY(_rotateYAmount);
                updateVariousNumbersForCamera();
				if (_videoDisplayed &&  _video.readyState === _video.HAVE_ENOUGH_DATA ) {
				  if (_videoTexture) _videoTexture.needsUpdate = true;
				}
			}
            function updateSkyDome(pid) {
	            _videoDisplayed = false;
	            video_stop();
                var pathToTexture = 'textures/' + pid + '.jpg';
				(new THREE.TextureLoader()).load(pathToTexture, function ( texture ) {
				    var skyMaterial = new THREE.MeshBasicMaterial({map: texture, side: THREE.DoubleSide });

					_skyBox.material = skyMaterial;

				});
            }
            function initVideo() {
                _video  = document.getElementById('video');
                _videoSource = document.createElement('source');
                _video.appendChild(_videoSource);
            }
			function updateVideo(pid) {
                console.log('in video: ' + pid);
                var pathToTexture = 'textures/' + pid + '.mp4';

                _videoSource.setAttribute('src', pathToTexture);
                _video.load();

                _videoTexture = new THREE.Texture(_video);
                _videoTexture.minFilter = THREE.LinearFilter;
                _videoTexture.magFilter = THREE.LinearFilter;
                _videoTexture.generateMipmaps = false;
                _video.play();

                _videoTexture.minFilter = THREE.LinearFilter;   // eliminates aliasing when tiling textures.
                var videoMaterial = new THREE.MeshBasicMaterial({
                    map: _videoTexture,
                    overdraw: true,
                    side: THREE.DoubleSide 
                });
                _skyBox.material = videoMaterial;
                _videoDisplayed = true;

			}
            var _unitVector;
            var _fixedPointX, _fixedPointY;
            function updateVariousNumbersForCamera() {
            	_unitVector = (new THREE.Vector3()).copy(_camera.position).normalize();
				// in three.js y is up. we want z to be up.
				// flip the signs on x and z because we're inside the sphere. i think?
				var x = -_unitVector.x;
				var y = _unitVector.z;	// assign z to y.
				var z = -_unitVector.y;	// assign y to z.

            	// convert to point on complex plane
            	_cameraLookAtComplexX = - x / (1.0 - z);
            	_cameraLookAtComplexY = - y / (1.0 - z);

            	try {
	                document.getElementById('unitVectorText').innerHTML = 
	                "<nobr>Unit Vec: (" + 
	                	_unitVector.x.toFixed(1) + "," + 
	                	_unitVector.z.toFixed(1) + "," + 
	                	_unitVector.y.toFixed(1) + ") len: " 
						+ _unitVector.length().toFixed(1) + "</nobr>" ;   

	                document.getElementById('complexPointText').innerHTML = "Looking at " + 
	                	_cameraLookAtComplexX.toFixed(2) + " + " + 
	                	_cameraLookAtComplexY.toFixed(2) + "i";

	                _textElement = document.getElementById('cameraText');
	                _textElement.innerHTML = "<nobr>Camera: (" + _camera.position.x.toFixed(1) 
	                	+ "," + _camera.position.y.toFixed(1) + ","  
	                	+ _camera.position.z.toFixed(1) + ") len: " 
						+ _camera.position.length().toFixed(1) + "</nobr>" ;
				}
				catch (x) {}
            }
            function flipCamera() {
            	_camera.position.x = - _camera.position.x;
            	_camera.position.y = - _camera.position.y;
            	_camera.position.z = - _camera.position.z;
            }
            $().ready(function() {
                init();
            });  // end of jquery ready function
</script>
<script type="text/javascript">

    function video_play() {
		var video = document.getElementById("video");
		video.play();
    }
    function video_stop() {
		var video = document.getElementById("video");
		video.pause();    	
    }
    function video_restart() {
        var video = document.getElementById("video");
        video.currentTime = 0;
		video.play();
    }

    function video_skip(value) {
        var video = document.getElementById("video");
        video.currentTime += value;
    }    
    function cameraLeft() {
        _rotateYAmount -= 0.002;
    }  
    function cameraRight() {
        _rotateYAmount += 0.002;
    }  
    function cameraStop() {
        _rotateYAmount = 0.;
    }  
</script>
</head>
	<body>
		<video  id="video"
		  style="display: none;
		  position: absolute; left: 15px; top: 75px;"
		  controls="true" autoplay="true">
		</video>
		<div id="container"><br /><br /><br /><br /><br />Generating...</div>
        <div style="position: fixed; top: 3%; width:95%; ">
            <div class="videoPanel">
                <div class="videoPanelInner">
                    <img src='icons/rewind.png' onclick='video_skip(-10)'  title="Video Back" class='videoControlIcon'></img>
                    <img src='icons/play.png' onclick='video_play()'  title="Video Play" class='videoControlIcon'></img>
                    <img src='icons/stop.png' onclick='video_stop()'  title="Video Stop" class='videoControlIcon'></img>
                    <img src='icons/ff.png' onclick='video_skip(10)'  title="Video FastForward" class='videoControlIcon'></img>
                    <img src='icons/replay.png' onclick='video_restart()'  title="Video Restart" class='videoControlIcon'></img>
                </div>
            </div>
            <div class="cameraPanel">
                <div class="cameraPanelInner">
                    <img src='icons/left.png' onclick='cameraLeft()'  title="Camera Left" class='cselector'></img>
                    <img src='icons/up.png' onclick='cameraUp()'  title="Camera Up" class='cselector'></img>
                    <img src='icons/down.png' onclick='cameraDown()'  title="Camera Down" class='cselector'></img>
                    <img src='icons/right.png' onclick='cameraRight()'  title="Camera Right" class='cselector'></img>
                    <img src='icons/stop.png' onclick='cameraStop()'  title="Camera Stop" class='cselector'></img>
                    <img src='icons/flipCamera.png' onclick='flipCamera()'  title="Flip Camera" class='cselector'></img>
                </div>
            </div>
            <div style="float: right; "  class="controlPanel ">
                <div class="controlPanelInner">
                    <div id="mediaList" class="controlPanel ">
<!--                     <div id="videoList" class="controlPanel ">
                    <div id="textureList"  class="controlPanelInner">
 -->                    </div>
                </div>
            </div>
        </div>
        <script>
        </script>
	</body>
</html>
