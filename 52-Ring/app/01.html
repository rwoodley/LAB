<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Anna Friz - Mers/Woodley</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				font-family:Monospace;
				font-size:13px;
				text-align:center;
                background: #bfd1e5;
				margin: 0px;
			}
            .gauges {
                margin: 4px;
                background: blue;
                width: 200px;
                height: 200px;
                border: 1px solid black;

            }
            #leftPanel {
                border-spacing: 0px;
                margin: 0px;
                background: blue;
/*                width: 600px;
                height: 600px;
*/
            }
            #rightPanel {
                border-spacing: 0px;
                margin: 0px;
                background: yellow;
/*                width: 600px;
                height: 600px;
*/            }

    </style>
    <script src="lib/jquery-1.11.2.min.js"></script>
    <script src="lib/chroma.min.js"></script>
    <script src="r71/three.min.js"></script>
    <script src="r71/OrbitControls.js"></script>
    <script src="r71/Detector.js"></script>
    <script src="math.js"></script>
    <script src="cameraNavigation.js"></script>
    <script src="leftpanel.js"></script>
    <script src="main.js"></script>
    <script src="mersRing.js"></script>
    <script src="shaders.js"></script>
    <script src="utils.js"></script>
    <script id="shaderParticleVertex" type="x-shader/x-vertex">
        uniform float amplitude;
        attribute float size;
        attribute vec3 customColor;
    
        varying vec3 vColor;
    
        void main() {
    
            vColor = customColor;
    
            vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
    
            //gl_PointSize = size;
            gl_PointSize = size * ( 300.0 / length( mvPosition.xyz ) );
    
            gl_Position = projectionMatrix * mvPosition;
    
        }
    </script>
    
    <script id="shaderParticleFragment" type="x-shader/x-fragment"> 
        uniform vec3 color;
        uniform sampler2D texture;
    
        varying vec3 vColor;
    
        void main() {
    
            gl_FragColor = vec4( color * vColor, 1.0 );
            gl_FragColor = gl_FragColor * texture2D( texture, gl_PointCoord );
    
        }
    </script>
	</head>
	<body>
        <table>
            <tr>
                <td>
                    <div id="leftPanel" >
                        <canvas id="leftCanvas" />
                    </div>
                </td>
                <td>
                    <div id="rightPanel">
                            <div id='upArrowContainer' style=' position: absolute;' onclick='upArrowClicked()' >
                                <img src='textures/arrow_up.png' id='upArrow' style='display: none' />
                                <img src='textures/arrow_up grey.png' id='upArrowGrey' style='display: none' />
                                <img src='textures/arrow_up light.png' id='upArrowLight' style='display: none' />
                            </div>
                            <div id='downArrowContainer' style=' position: absolute;' onclick='downArrowClicked()' >
                                <img src='textures/arrow_down.png' id='downArrow' />
                            </div>
                            <canvas id="rightCanvas" />
                    </div>
                </td>
            </tr>
        </table>
        <table><tr><td>
        </td><td>
        </td></tr></table>
        <audio id='0' style="display: none;">
		</audio> 
        <audio id='1' style="display: none;">
		</audio> 
        <audio id='2' style="display: none;">
		</audio> 
        <audio id='3' style="display: none;">
		</audio> 
        <audio id='4' style="display: none;">
		</audio> 
        <audio id='5' style="display: none;">
		</audio> 
        <audio id='6' style="display: none;">
		</audio> 
        <audio id='7' style="display: none;">
		</audio> 
        <audio id='8' style="display: none;">
		</audio> 
        <script>
            $(document).ready(function() {
                loops = [
                    'audio/01.mp3',
                    'audio/02.mp3',
                    'audio/03.mp3',
                    'audio/04.mp3',
                    'audio/05.mp3',
                    'audio/06.mp3',
                    'audio/induction_song.mp3',
                    'audio/Friz_drone_planet_chile.mp3',
                    'audio/dog_drone_chile.mp3'
                ];
                addEventListener('touchstart', function (e) { initializeAudio();  });
                addEventListener('click', function (e) { initializeAudio();  });
                document.getElementById('upArrowContainer').addEventListener("touchend", upArrowClicked, false);
                document.getElementById('downArrowContainer').addEventListener("touchend", downArrowClicked, false);
            });
            var _firstTime = true;
            function initializeAudio() {
                if (!_firstTime) return;
                _firstTime = false;
                console.log("initing audio");
                for (var i = 0; i < 9; i++) {
                    soundHandle = document.getElementById(i);
                    soundHandle.src = loops[i];
                    soundHandle.loop = true;
                    soundHandle.play();
                    soundHandle.pause();
                }
                startPlayingAudioForFirstWedge();
            }
            var leftPanel, rightPanel, _navigator;
            function resizeDiagram() {
                console.log(document.body.offsetWidth + "," + document.body.offsetHeight);
                var width = Math.floor((document.body.offsetWidth - 20)/2);
                document.getElementById('leftPanel').width = width ;
                document.getElementById('leftPanel').height = width ;
                document.getElementById('rightPanel').width = width ;
                document.getElementById('rightPanel').height = width ;
                document.getElementById('leftCanvas').width = width ;
                document.getElementById('leftCanvas').height = width ;
                document.getElementById('rightCanvas').width = width ;
                document.getElementById('rightCanvas').height = width ;
                width += 'px';
                document.getElementById('leftCanvas').style.width = width ;
                document.getElementById('leftCanvas').style.height = width ;
                document.getElementById('rightCanvas').style.width = width ;
                document.getElementById('rightCanvas').style.height = width ;

                document.getElementById('leftPanel').style.width = width ;
                document.getElementById('leftPanel').style.height = width ;
                document.getElementById('rightPanel').style.width = width ;
                document.getElementById('rightPanel').style.height = width ;

                redrawForCamera(leftPanel._camera, document.getElementById('leftCanvas'), leftPanel._renderer);
                redrawForCamera(rightPanel._camera, document.getElementById('rightCanvas'), rightPanel._renderer);

                var rightEL = document.getElementById('rightPanel');

                var el = document.getElementById('upArrowContainer');
                el.style.top = (rightEL.offsetTop + rightEL.offsetHeight*.725) + 'px';
                el.style.left = (rightEL.parentElement.offsetLeft + rightEL.offsetWidth*.4) + 'px';

                positionUpArrow('upArrow');

                var el = document.getElementById('downArrowContainer');
                el.style.top = (rightEL.offsetTop + rightEL.offsetHeight*.85) + 'px';
                el.style.left = (rightEL.parentElement.offsetLeft + rightEL.offsetWidth*.48) + 'px';

                var width = window.getComputedStyle(rightEL.parentElement).width.replace('px','');
                var img = document.getElementById('downArrow');
                img.style.width = (width*.15)+'px';
                img.style.height = img.style.width;
            }
            function positionUpArrow(imgName) {
                document.getElementById('upArrow').style.display='none';
                document.getElementById('upArrowGrey').style.display='none';
                document.getElementById('upArrowLight').style.display='none';
                var rightEL = document.getElementById('rightPanel');
                var img = document.getElementById(imgName);
                img.style.display='inline-block'
                var width = window.getComputedStyle(rightEL.parentElement).width.replace('px','');
                img.style.width = (width*.15)+'px';
                img.style.height = img.style.width;
            }
            function redrawForCamera(camera, canvas, renderer) {
                renderer.setViewport(0, 0, canvas.clientWidth, canvas.clientHeight);
                camera.aspect = canvas.clientWidth / canvas.clientHeight;
                camera.updateProjectionMatrix();
            }
            
            window.onresize = resizeDiagram;
            window.addEventListener('orientationchange', function (e) { setTimeout(resizeDiagram, 250); });
            leftPanel = new LeftPanel(document.getElementById('leftPanel'), document.getElementById('leftCanvas'), new THREE.Vector3(90, 50, 0));
            rightPanel = new MainApp(
                document.getElementById('rightPanel'),
                document.getElementById('rightCanvas')
                                 );
            _navigator = new cameraNavigator(rightPanel._camera, leftPanel.listener);
            animate();
            function upArrowClicked() {
                _navigator.forwards();
                positionUpArrow(leftPanel.leftRing._closeToWall == 0 ? 'upArrow' : leftPanel.leftRing._closeToWall == 1 ? 'upArrowGrey' : 'upArrowLight');
                console.log('===' + leftPanel.leftRing._closeToWall);
            }
            function downArrowClicked() {
                _navigator.backwards();
                positionUpArrow(leftPanel.leftRing._closeToWall == 0 ? 'upArrow' : leftPanel.leftRing._closeToWall == 1 ? 'upArrowGrey' : 'upArrowLight');
                console.log('===' + leftPanel.leftRing._closeToWall);
            }
            function animate() {
                requestAnimationFrame( animate );    
                render();
            }
            var _tick = 0;
            function render() {
                rightPanel._renderer.render( rightPanel._scene, rightPanel._camera );
                leftPanel.render(rightPanel._camera.position);
                //renderMaterials(_that._clock.getDelta());
                if (_tick == 0) {
                    resizeDiagram();
                    _tick++;
                }
            }
        </script>
	</body>
</html>
