<!DOCTYPE html>
<html lang="en">
    <style>
        body {
            background: #ccc;
        }
    </style>
	<body>
        <div id="container"><br /><br /><br /><br /><br />Generating world...</div>
       <div style="position: fixed; top: 3%; width:95%; ">
            <div style="float: right; ">
                 <span id='text1' style="display:inline-block;height:30px;width:100px;color:#00aa00;"></span>
            </div>
            <div style="float: right; ">
                 <span id='text2' style="display:inline-block;height:30px;width:100px;color:#000000;"></span>
            </div>
        </div>
        <script src="r73/three.js"></script>
        <script src="r73/OrbitControls.js"></script>
        <script src="r73/Mirror.js"></script>
        <script src="r73/FresnelShader.js"></script>
        <script src="geometry.js"></script>
        <script src="myCubeCamera.js"></script>
        <script src="innerWorld.js"></script>
        <script src="WaterShader.js"></script>
        <script src="utils.js"></script>
        <script src="libs/jquery-2.1.4.min.js"></script>
        <script src="libs/d3-threeD.js"></script>
<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="864px"
            height="864px" viewBox="0 0 864 864" enable-background="new 0 0 864 864" xml:space="preserve">
<g>
                <path id='cake'  fill="none" stroke="#000000" stroke-miterlimit="10" d="M201.295,551.723c-5.838-4.511-11.678-9.027-17.519-13.542c-2.542-1.961-5.116-3.963-7.037-6.532c-3.583-4.809-4.505-11.2-3.696-17.137c0.811-5.939,3.193-11.538,5.713-16.979c1.799-3.879,3.701-7.756,6.331-11.133c5.052-6.485,12.417-10.681,19.584-14.705c2.575-1.45,5.188-2.911,8.048-3.647c6.286-1.614,12.907,0.462,18.852,3.061c8.143,3.562,15.832,8.151,22.828,13.629c0.753,0.59,1.529,1.23,1.877,2.119c0.539,1.372-0.08,2.9-0.137,4.375c-0.136,3.461,2.845,6.268,5.944,7.817c3.1,1.547,6.599,2.395,9.302,4.562c0.621,0.494,1.209,1.089,1.454,1.847c0.96,2.958-3.735,5.479-2.936,8.488c2.613,1.297,4.163,4.446,3.592,7.306c3.259,4.289,0.4,10.48,1.333,15.781c0.494,2.811,2.057,5.303,2.955,8.008c0.896,2.708,0.968,6.058-1.095,8.022c-1.947,1.859-5.038,1.193-7.654,1.828c-5.781,1.403-12.793,5.084-27.496,5.232c-9.35,0.095-18.941,3.172-27.606-0.35C209.289,557.892,205.26,554.79,201.295,551.723z"/>
            </g>
 <g>
                <path id='muffin'  fill-rule="evenodd" clip-rule="evenodd" fill="none" stroke="#000000" stroke-miterlimit="10" d="M320.685,479.567c0.819,0,1.638,0,2.457,0c0.003,0.173,0.006,0.345,0.009,0.518c-4.403,0-8.811,0.104-13.211-0.021c-12.115-0.342-24.269-0.318-36.324-1.384c-5.711-0.505-11.463-1.14-17.155-1.87c-3.772-0.484-7.364-2.899-10.871-4.761c-3.156-1.676-6.304-3.516-9.026-5.795c-1.457-1.219-2.022-3.513-2.958-5.337c-0.218-0.425-0.168-1.134-0.483-1.34c-4.007-2.607-3.188-6.659-3.205-10.46c-0.011-2.53-0.341-5.121,0.089-7.575c0.643-3.672,2.043-7.207,2.741-10.873c1.604-8.43,9.923-11.498,13.994-17.924c1.466-2.315,3.384-4.521,4.149-7.061c1.143-3.791-0.57-6.895-3.625-9.513c-3.55-3.043-3.983-7.208-2.276-11.602c1.002-2.579,1-5.207-1.119-7.673c-0.973-1.132-1.056-3.114-1.324-4.748c-0.683-4.163-1.156-8.278,1.1-12.266c0.747-1.32,0.506-3.16,0.974-4.683c0.993-3.238,1.695-6.69,3.36-9.567c2.191-3.784,1.696-9.805-2.375-12.649c-4.211-2.941-7.991-6.52-11.835-9.96c-4.165-3.727-4.19-8.598-3.305-13.597c0.926-5.232,3.8-9.344,7.842-12.599c9.097-7.324,18.268-14.558,27.451-21.774c2.368-1.861,4.927-3.477,7.343-5.28c3.752-2.801,5.387-8.608-0.15-12.012c-2.262-1.39-4.633-2.763-6.488-4.611c-2.161-2.154-3.881-4.771-5.652-7.286c-0.794-1.128-0.993-2.736-1.905-3.71c-3.374-3.604-3.653-8.072-3.254-12.455c0.442-4.858,1.176-9.813,2.725-14.409c1.287-3.818,4.108-7.093,5.922-10.77c1.168-2.367,1.746-5.026,2.584-7.555c0.663-2.002,1.237-4.039,1.998-6.003c1.452-3.749,3.09-7.428,4.476-11.201c0.441-1.201,0.428-2.604,0.447-3.917c0.036-2.549,0.464-4.321,3.172-5.92c3.222-1.903,5.448-5.413,8.39-7.889c5.078-4.276,10.456-8.195,15.55-12.452c3.049-2.547,6.446-3.446,10.301-4.086c4.401-0.731,8.549-2.875,12.919-3.948c4.526-1.111,7.034-4.531,9.896-7.604c4.497-4.83,10.696-5.312,16.51-5.829c18.857-1.676,37.692-4.938,56.671-3.434c11.985,0.95,23.948,2.944,35.725,5.409c4.821,1.009,9.192,4.375,13.647,6.883c8.064,4.541,16.312,8.842,23.938,14.041c3.937,2.683,6.547,7.245,10.069,10.631c1.848,1.776,2.091,3.613,2.088,5.892c-0.041,32.327,0.114,64.654-0.097,96.979c-0.086,13.149,0.164,26.456-1.746,39.395c-1.968,13.335-0.503,26.597-1.659,39.822c-0.653,7.478-2.05,14.891-3.14,22.329c-1.401,9.569-7.359,16.973-11.907,25.054c-1.953,3.469-4.59,6.639-4.183,11.138c0.12,1.334-1.458,2.748-1.942,4.228c-0.654,1.999-1.405,4.094-1.422,6.153c-0.119,14.736-0.02,14.784-11.516,25.286c-5.018,4.583-10.125,9.089-15.437,13.323c-3.815,3.042-7.907,5.919-13.339,4.807c-0.505-0.104-1.092,0.125-1.628,0.253c-2.507,0.597-5.022,1.761-7.51,1.697c-4.183-0.105-8.091,0.146-11.682,2.526c-0.723,0.479-1.782,0.892-2.578,0.745c-6.079-1.117-10.142,2.563-14.359,5.871c-2.424,1.901-4.625,4.133-7.211,5.765c-1.909,1.205-4.223,1.934-6.454,2.433c-4.592,1.027-9.218,2.118-13.888,2.533c-7.961,0.707-15.968,0.895-23.952,1.341c-3.194,0.178-6.382,0.636-9.572,0.639c-2.24,0.001-4.481-0.552-6.722-0.856C320.719,479.189,320.702,479.378,320.685,479.567z"/>
            </g>        </svg>        
		<script>
    document.getElementById('muffin').style.display = 'none';
    document.getElementById('cake').style.display = 'none';

    var _container, render_stats, physics_stats;
    var _camera, _controls, _scene, _renderer;
    var _boxPivotPoint, textElement, _shaderMaterial;
    _textElement = document.getElementById('text1');
    _textElement2 = document.getElementById('text2');
    var _scene = new THREE.Scene();

    _container = document.getElementById( 'container' );

    _renderer =  new THREE.WebGLRenderer({antialias: true, alpha: true});
    _renderer.setSize( window.innerWidth, window.innerHeight );
    document.getElementById( 'container' ).innerHTML = "";
    _container.appendChild( _renderer.domElement );

    _camera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 20000 );
    _camera.position.x = 0; _camera.position.y = 20; _camera.position.z = -56;

    var axes = new THREE.AxisHelper( 5000 );

    _scene.add(axes);

    var _innerCamera = new THREE.PerspectiveCamera( 60, window.innerWidth / window.innerHeight, 1, 20000 );
    _innerCamera.position.x = 6; _innerCamera.position.y = 2; _innerCamera.position.z = 109;
   
    var _cubeCamera = new BOB.CubeCamera( 0.1, 30000, 512 );
    _cubeCamera.renderTarget.minFilter = THREE.LinearMipMapLinearFilter;
    _cubeCamera.renderTarget.mapping = THREE.CubeRefractionMapping;

    _controls = new THREE.OrbitControls( _camera, _container.domElement );

    var _innerWorld = new innerWorld();
    var _waterY = -150;    
    var _innerScene = _innerWorld.init(_innerCamera, _renderer, _waterY);

    var uvTexture = THREE.ImageUtils.loadTexture('textures/uv.jpg');

    var ambientLight = new THREE.AmbientLight(0xfffffff);
    _scene.add(ambientLight);
    var basicMaterial = new THREE.MeshPhongMaterial({color:0xffffff, 
        envMap: _cubeCamera.renderTarget,
        refractionRatio: 0.99,
        side: THREE.BackSide,
    });

    cube = makeProfileLatheMesh(basicMaterial);
    cube.position.x = 0;     cube.position.y = 0;     cube.position.z = 0;
    _scene.add(cube);

                
    var clock = new THREE.Clock();
    requestAnimationFrame( render );

    var _matrix = new THREE.Matrix4();
    var _tick = 1;

    // _camera.up.set(0,-1,0);
    loadSkyBox(_innerScene);
    // loadSkyDome(_innerScene, 'textures/1.jpg');
    loadSkyDome(_scene, 'textures/hermit-island-panorama-small.jpg');

    // var _lookAtVector = new THREE.Vector3(0, _waterY + 110,0);
    var _lookAtVector = new THREE.Vector3(0, 0,0);
    function render() {
        //cube.rotation.x = -_tick * Math.PI/256;
        requestAnimationFrame( render );
        _controls.update( clock.getDelta() );

        rotateCameraY(_camera, Math.PI/2048);
        _camera.lookAt(new THREE.Vector3(0,0,0));

        var radians = _camera.position.x == 0 ? Math.PI/2 : Math.atan(_camera.position.z/_camera.position.x);
        if (radians < 0)
            radians += Math.PI; 
        _innerCamera.position.x = Math.cos(radians)*1;
        _innerCamera.position.z = Math.sin(radians)*1;

        _innerCamera.position.x = _camera.position.x/10.;
        _innerCamera.position.z = _camera.position.z/10.;

        // if (_innerCamera.position.y <= _waterY+5)
        //     _innerCamera.position.y = _waterY+6;
        _innerCamera.lookAt(_lookAtVector);

        _innerWorld.render(_lookAtVector);

        _textElement.innerHTML = "<nobr>(" + Math.floor(_camera.position.x) + "," + Math.floor(_camera.position.y) + ","  + Math.floor(_camera.position.z) + ")</nobr>" ;
        _textElement2.innerHTML = "<nobr>(" + Math.floor(_innerCamera.position.x) + "," + Math.floor(_innerCamera.position.y) + ","  + Math.floor(_innerCamera.position.z) + ")</nobr>" ;
        // _textElement.innerHTML = "<nobr>(" + radians.toFixed(2) + ")</nobr>" ;
        _renderer.render(_innerScene, _innerCamera);
        _cubeCamera.updateCubeMap(_renderer, _innerScene);

        _renderer.render( _scene, _camera );
        _tick++;
    }
</script>
	</body>
</html>
